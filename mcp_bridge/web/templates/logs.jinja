{% extends "base.jinja" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>Chat Completion Logs</h2>
    </div>
</div>

<div class="row">
    <div class="col">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Model</th>
                        <th>Total Tokens</th>
                        <th>Tools Used</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for completion in completions %}
                    <tr>
                        <td>{{ completion.timestamp }}</td>
                        <td>{{ completion.model }}</td>
                        <td>{{ completion.total_tokens }}</td>
                        <td>{{ completion.tool_count }} tools</td>
                        <td>
                            <button class="btn btn-sm btn-primary" 
                                    onclick="showDetails('{{ completion.id }}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for details -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chat Completion Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="completionDetails"></div>
                <h6 class="mt-4">Tool Calls</h6>
                <div id="toolCalls"></div>
            </div>
        </div>
    </div>
</div>

<script>
async function showDetails(completionId) {
    const response = await fetch(`/logs/${completionId}`);
    const data = await response.json();
    
    const details = data.completion;
    const tools = details.request.tools || [];
    const toolsList = tools.map(tool => tool.function?.name || tool.type).filter(Boolean);
    
    let detailsHtml = `
        <div class="row">
            <!-- Request Column -->
            <div class="col-md-4 pe-md-2">
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>Request Details</h6>
                        <div class="mb-3">
                            <strong>Model:</strong> ${details.model}<br>
                            <strong>Tokens:</strong> ${details.total_tokens} 
                            (${details.prompt_tokens} prompt, ${details.completion_tokens} completion)
                        </div>
                        
                        ${toolsList.length > 0 ? `
                        <div class="mb-3">
                            <h6>Available Tools:</h6>
                            <div class="badge-group">
                                ${toolsList.map(tool => `<span class="badge bg-secondary me-1">${tool}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#requestCollapse">
                                        View Full Request
                                    </button>
                                </h2>
                                <div id="requestCollapse" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <pre class="bg-light p-2"><code>${JSON.stringify(details.request, null, 2)}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool Calls Column -->
            <div class="col-md-4 px-md-2">
                <div class="card">
                    <div class="card-body">
                        <h6>Tool Calls</h6>
                        <div class="tool-calls">
                            ${data.tool_calls.map(tool => {
                                let arguments = tool.arguments;
                                let result = tool.result;
                                
                                try {
                                    if (typeof arguments === 'string') arguments = JSON.parse(arguments);
                                    if (typeof result === 'string') result = JSON.parse(result);
                                } catch (e) {
                                    console.error('Failed to parse tool data:', e);
                                }
                                
                                return `
                                    <div class="tool-call mb-3">
                                        <h6 class="tool-name">${tool.tool_name}</h6>
                                        <div class="tool-details">
                                            <strong>Arguments:</strong>
                                            <pre class="bg-light p-2 mb-2"><code>${JSON.stringify(arguments, null, 2)}</code></pre>
                                            <strong>Result:</strong>
                                            <pre class="bg-light p-2"><code>${JSON.stringify(result, null, 2)}</code></pre>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Column -->
            <div class="col-md-4 ps-md-2">
                <div class="card">
                    <div class="card-body">
                        <h6>Conversation</h6>
                        <div class="chat-messages">
                            ${details.request.messages.map(msg => `
                                <div class="message ${msg.role}">
                                    <strong>${msg.role}:</strong>
                                    <div class="content">${msg.content}</div>
                                </div>
                            `).join('')}
                            ${details.final_response ? `
                                <div class="message final-response">
                                    <strong>Final Response:</strong>
                                    <div class="content">${details.final_response.content}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('completionDetails').innerHTML = detailsHtml;
    document.getElementById('toolCalls').innerHTML = '';
    
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}
</script>

<style>
.modal-dialog {
    max-width: 90%;
    margin: 1.75rem auto;
}

.chat-messages {
    max-height: 60vh;
    overflow-y: auto;
}

.tool-calls {
    max-height: 60vh;
    overflow-y: auto;
}

.message {
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-radius: 4px;
}

.message.user {
    background-color: #f8f9fa;
}

.message.assistant {
    background-color: #e9ecef;
}

.message .content {
    white-space: pre-wrap;
    margin-top: 0.5rem;
}

.badge-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.tool-call {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
}

.tool-call:last-child {
    border-bottom: none;
}

.tool-name {
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

pre {
    margin-bottom: 0;
    max-height: 200px;
    overflow-y: auto;
}

@media (max-width: 767.98px) {
    .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
    }
    
    .col-md-7, .col-md-5 {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
}

.final-response {
    background-color: #e3f2fd;
    border-left: 4px solid #0d6efd;
}

.col-md-4 {
    margin-bottom: 1rem;
}

@media (min-width: 768px) {
    .col-md-4 {
        margin-bottom: 0;
    }
}
</style>
{% endblock %}